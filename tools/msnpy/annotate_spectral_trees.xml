<tool id="msnpy_annotate_spectral_trees" name="MSnPy Annotate Spectral Trees" version="@TOOL_VERSION@+galaxy@GALAXY_TOOL_VERSION@">
    <description> - Annotate and/or filter spectral trees.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <stdio>
        <exit_code level="fatal" range="1:"/>
    </stdio>
    <version_command>python msnpy annotate-spectral-trees --version</version_command>
    <command>
    <![CDATA[
        msnpy annotate-spectral-trees
        #if $input and $input is not None:
            --input '$input'
        #end if

        #if $mf_db and $mf_db is not None:
            --mf-db $mf_db
        #end if

        #if $ppm and $ppm is not None:
            --ppm $ppm
        #end if

        --ion-mode $type

        #if $adducts_cond.input_type == 'predefined'
            #for $a in $ion_mode_cond.adducts_cond.adducts_predefined
                --adducts $a
            #end for
        #else if $adducts_cond.input_type == 'manual'
            #for $a in $adducts_cond.adducts_manual
                --adducts '$a.name' $a.exact_mass
            #end for
        #else
           --adducts-file $adducts_cond.adducts_file
        #end if

        $rules
        $filter
        
	#if $time_limit_cond.time_limit_choice
	   --time-limit $time_limit_cond.time_limit
	#end if
        
        --output-db $annotation_db
        --output-trees $output_trees
    ]]>
    </command>
    <inputs>
        <param name="input" type="data" format="json" label="Spectra trees" help="Json file containing spectral trees">
            <validator type="empty_field" />
        </param>
        <param argument="--mf-db" label="Molecular formulae database" name="mf_db" optional="true" type="text"
               value="https://mfdb.bham.ac.uk"/>
        <param name="type" type="select" label="Ion mode">
                <option value="pos" selected="True">Positive</option>
                <option value="neg">Negative</option>
        </param>
        <conditional name="adducts_cond">
            <param name="input_type" label="Input type adducts" type="select" help="">
                <option value="predefined" selected="True">Predefined list of adducts</option>
               	<option value="file">Provide a tab-separated text file with a list of adducts</option>
                <option value="manual">Enter a list of adducts</option>
       	    </param>
            <when value="predefined">
                <param argument="adducts_predefined" label="Predefined list of adducts" type="select" help="" multiple="true" display="checkboxes">
                    <option value="[M+H]+ 1.007276" selected="True">[M+H]+ 1.007276</option>
                    <option value="[M+Na]+ 22.989221">[M+Na]+ 22.989221</option>
                    <option value="[M+K]+ 38.963158">[M+K]+ 38.963158</option>
                    <option value="[M-H]- -1.007276">[M-H]- -1.007276</option>
                    <option value="[M+Cl]- 34.969401">[M+Cl]- 34.969401</option>
                    <option value="[M+Na-2H]- 38.963158">[M+Na-2H]- 20.974668</option>
                    <option value="[M+K-2H]- 38.963158">[M+K-2H]- 36.948605</option>
                    <option value="[M+Hac-H]- 38.963158">[M+Hac-H]- 59.013853</option>
                </param>
           </when>
           <when value="manual">
               <repeat name="adducts_manual" title="Adduct" default="1">
                   <param name="name" type="text" value="[M+H]+" label="Name">
                       <validator type="empty_field"/>
                   </param>
                   <param name="exact_mass" type="float" value="-1.007276" label="Exact mass" />
              </repeat>              
           </when>
           <when value="file">
               <param name="adducts_file" type="data" format="tsv" label="List of adducts" help="Tab-separated text file containing three columns: name, exact_mass, ion_mode." />
           </when>
        </conditional>
        <param argument="--ppm" label="Mass tolerance in Parts per million." name="ppm" optional="true" type="float" value="2.0"/>
        <param argument="--rules" checked="true" label="Apply heuristic rules?" name="rules" type="boolean" truevalue="--rules" falsevalue=""/>
        <param argument="--filter" checked="true" label="Filter the spectral tree annotations?"
               type="boolean" truevalue="--filter" falsevalue=""/>
        <conditional name="time_limit_cond">
        	<param name="time_limit_choice" checked="false" label="Use time limit?" type="boolean" truvalue="true" falsevalue="false" />
		<when value="true">
			<param argument="--time-limit" label="Time limit to annotate and filter each tree (seconds)" name="time_limit" optional="true" type="float" value="7200"/>
		</when>
	</conditional>
    </inputs>
    <outputs>
        <data format="json" hidden="false" name="output_trees" label="${tool.name} on ${on_string}: Spectral trees (json)"/>
        <data format="sqlite" hidden="false" name="annotation_db" label="${tool.name} on ${on_string}: Annotation db (sqlite)"/>
    </outputs>
    <tests>
        <test>
            <param name="input" value="A08_spectral_trees.json" ftype="json"/>
            <output name="output_trees" value="A08_annotated_trees.json"/>
            <output name="annotation_db" value="A08_mf_annotation_db.sqlite"/>
        </test>
    </tests>

    <help>
Annotate and filter spectral trees
==========================================================================

Description
----------------

    </help>
    <expand macro="citations" />
</tool>
